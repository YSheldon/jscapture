<!DOCTYPE html>
<html lang="en">
<head height="508" width="642">
    <meta charset="UTF-8">
    <title>转发</title>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/contacts.css">
    <style>
        .top_title span {
            padding-left: 13px;
            background: none;
        }

        .con_box {
            position: absolute;
            top: 32px;
            bottom: 0;
            right: 0;
            left: 0;
            width: 100%;
        }

        .contacts_leftContent {
            position: absolute;
            top: 38px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            /*position: relative;"*/
        }

        .contacts_right_scroll {
            position: absolute;
            top: 41px;
            bottom: 51px;
            left: 0;
            right: 0;
        }

    </style>

    <link rel="stylesheet" href="css/layer.css">
    <script type="text/javascript" src="js/iscroll-5.1.3.min.js"></script>
    <script type="application/javascript" src="js/jQuery-2.1.4.min.js"></script>
    <script type="application/javascript" src="js/application.js"></script>
    <script src="js/my_layer.js"></script>
    <script type="text/javascript" src="./js/xss.min.js"></script>
    <!--<script src="js/vue.js"></script>-->

</head>
<body>
<div class="out_box">
    <div class="top_title">
        <span >转发</span>
        <ul class="tool">
            <li class="Winclose"></li>
        </ul>
    </div>
    <div class="con_box">
        <div class="contacts_left tran_l">
            <div style="height: 38px;line-height: 38px; text-align: center;padding:0 5px ;position: relative" class="Ct_seach">
                <em></em><input type="text" class="search" id="search" placeholder="" value="搜索"><em id="search_del"
                                                                                                     style="display: none"></em>
            </div>
            <div class="contacts_leftContent" id="contact_scroll_left" style="display: block">

                <div class="contactcontent ">

                    <div class="contacts_person_scroll contacts_type" id="contacts_person_scroll">
                        <ul id="con_l" class="con">
                            <!--<li>-->
                            <!--<em class="aV_check unchecked"></em>-->
                            <!--<img src="images/persion.png" alt="">-->
                            <!--<span class="name">张雪峰、张海洋、周利红、周利红测试1、乔海丰测试账...等</span>-->
                            <!--<span>来袭大叔大婶大的上</span>-->
                            <!--</li>-->
                            <!--<li>-->
                            <!--<em class="aV_check unchecked"></em>-->
                            <!--<img src="images/persion.png" alt="">-->
                            <!--<span class="name">高秀玉、金程、高秀玉哈哈、乔海丰测试账...、季国玉</span>-->
                            <!--<span>来袭大叔大婶大的上</span>-->
                            <!--</li>-->
                            <!--<li>-->
                            <!--<em class="unchecked"></em>-->
                            <!--<img src="images/persion.png" alt="">-->
                            <!--<span class="name">蓝信3</span>-->
                            <!--<span>来袭大叔大婶大的上</span>-->
                            <!--</li>-->
                            <!--<li>-->
                            <!--<em class="unchecked"></em>-->
                            <!--<img src="images/persion.png" alt="">-->
                            <!--<span class="name">蓝信4</span>-->
                            <!--<span>来袭大叔大婶大的上</span>-->
                            <!--</li>-->
                            <!--<li>-->
                            <!--<em class="unchecked"></em>-->
                            <!--<img src="images/persion.png" alt="">-->
                            <!--<span class="name">蓝信5</span>-->
                            <!--<span>来袭大叔大婶大的上</span>-->
                            <!--</li>-->
                            <!--<li>-->
                            <!--<em class="unchecked"></em>-->
                            <!--<img src="images/persion.png" alt="">-->
                            <!--<span class="name">蓝信6</span>-->
                            <!--<span>来袭大叔大婶大的上</span>-->
                            <!--</li>-->

                        </ul>
                        <ul id="con_l_search" class="con contacts_search_con con_l_search disN">
                            <!--<h6 class="contactType">最近会话</h6>-->
                            <!--<ul>-->
                                <!--<li>-->
                                <!--<em class="aV_check unchecked"></em>-->
                                <!--<img src="images/persion.png" alt="">-->
                                <!--<span class="name">张雪峰、张海洋、周利红、周利红测试1、乔海丰测试账...等</span>-->
                                <!--<span>来袭大叔大婶大的上</span>-->
                                <!--</li>-->
                                <!--<li>-->
                                <!--<em class="aV_check unchecked"></em>-->
                                <!--<img src="images/persion.png" alt="">-->
                                <!--<span class="name">高秀玉、金程、高秀玉哈哈、乔海丰测试账...、季国玉</span>-->
                                <!--<span>来袭大叔大婶大的上</span>-->
                                <!--</li>-->
                            <!--</ul>-->
                            <!--<h6 class="contactType">组织联系人</h6>-->
                            <!--<ul>-->
                                <!--<li>-->
                                    <!--<em class="aV_check unchecked"></em>-->
                                    <!--<img src="images/persion.png" alt="">-->
                                    <!--<span class="name">张雪峰、张海洋、周利红、周利红测试1、乔海丰测试账...等</span>-->
                                    <!--<span>来袭大叔大婶大的上</span>-->
                                <!--</li>-->
                                <!--<li>-->
                                    <!--<em class="aV_check unchecked"></em>-->
                                    <!--<img src="images/persion.png" alt="">-->
                                    <!--<span class="name">高秀玉、金程、高秀玉哈哈、乔海丰测试账...、季国玉</span>-->
                                    <!--<span>来袭大叔大婶大的上</span>-->
                                <!--</li>-->
                            <!--</ul>-->

                        </ul>

                    </div>
                    <!--<div class=" contacts_search_scroll" id="contacts_search_scroll" style="overflow: hidden; width: 100%; border-top: 1px solid rgb(217, 220, 226); display: none; height: 707px;">-->
                    <!--<div>-->
                    <!--<div class="contacts_search_con">-->
                    <!--<li>-->
                    <!--<em class="unchecked"></em>-->
                    <!--<img src="images/persion.png" alt="">-->
                    <!--<span>蓝信</span>-->
                    <!--<span>来袭大叔大婶大的上</span>-->
                    <!--</li>-->
                    <!--<li>-->
                    <!--<em class="unchecked"></em>-->
                    <!--<img src="images/persion.png" alt="">-->
                    <!--<span>蓝信</span>-->
                    <!--<span>来袭大叔大婶大的上</span>-->
                    <!--</li>-->
                    <!--<li>-->
                    <!--<em class="unchecked"></em>-->
                    <!--<img src="images/persion.png" alt="">-->
                    <!--<span>蓝信</span>-->
                    <!--<span>来袭大叔大婶大的上</span>-->
                    <!--</li>-->
                    <!--<li>-->
                    <!--<em class="unchecked"></em>-->
                    <!--<img src="images/persion.png" alt="">-->
                    <!--<span>蓝信</span>-->
                    <!--<span>来袭大叔大婶大的上</span>-->
                    <!--</li>-->
                    <!--<li>-->
                    <!--<em class="unchecked"></em>-->
                    <!--<img src="images/persion.png" alt="">-->
                    <!--<span>蓝信</span>-->
                    <!--<span>来袭大叔大婶大的上</span>-->
                    <!--</li>-->
                    <!--<li>-->
                    <!--<em class="unchecked"></em>-->
                    <!--<img src="images/persion.png" alt="">-->
                    <!--<span>蓝信</span>-->
                    <!--<span>来袭大叔大婶大的上</span>-->
                    <!--</li>-->
                    <!--<li>-->
                    <!--<em class="unchecked"></em>-->
                    <!--<img src="images/persion.png" alt="">-->
                    <!--<span>蓝信</span>-->
                    <!--<span>来袭大叔大婶大的上</span>-->
                    <!--</li>-->
                    <!--<li>-->
                    <!--<em class="unchecked"></em>-->
                    <!--<img src="images/persion.png" alt="">-->
                    <!--<span>蓝信</span>-->
                    <!--<span>来袭大叔大婶大的上</span>-->
                    <!--</li>-->


                    <!--</div>-->
                    <!--<div class="noSearch"-->
                    <!--style="position: absolute;top: 150px;text-align: center;width: 100%;display: none">-->
                    <!--<span>没有搜索结果</span>-->
                    <!--</div>-->
                    <!--</div>-->
                    <!--</div>-->

                </div>
            </div>

            <div style="top: 30%; text-align: center;position: absolute;width: 100%;display:none" class="Contact_load">
                <img src="./images/ajax-loader_smail.gif" alt="">
            </div>
        </div>
        <div class="contacts_right">
            <h5>已选择<span id="sel_count">0</span>/50人</h5>
            <div id="contacts_right_scroll" class="contacts_right_scroll" style="overflow: hidden;">
                <ul class="SelecedContact" id="con_r" style="padding-left: 13px">
                    <!--<li ><img src="../../images/defuser.png" alt=""><span>张雪峰、张海洋、周利红、周利红测试1、乔海丰测试账...等</span><em></em></li>-->
                    <!--<li ><img src="../../images/defuser.png" alt=""><span>高秀玉、金程、高秀玉哈哈、乔海丰测试账...、季国玉</span><em></em></li>-->
                </ul>
            </div>
            <div style="width: 100%;text-align: center" class="btn_container">
                <button class="btnCancel" id="btnCancel">取消</button>
                <button class="btnOK" id="btnOk">确认</button>
            </div>
        </div>
    </div>

</div>

</body>
</html>

<script>


    var leftScroll,
            rightScroll;
    var memberlist = [];

    function scroll() {
//    leftscroll=new iscroll
        var option = {
            probeType: 2,
            scrollbars: "custom",
            mouseWheel: true,
            bounce: false,
            interactiveScrollbars: true,
            shrinkScrollbars: 'scale',
            preventDefault: false,
            momentum: false,
        };

        leftScroll = new IScroll('#contact_scroll_left', option);
        rightScroll = new IScroll('#contacts_right_scroll', option);

    }
    var datalist, initdata, initJsondata;
    window.onload = function () {

        //查询所有的最近联系人或者群;
        scroll();
        bindEvent();
        var parm = {}
        try {
            window.lxpc.exebusinessaction('Transmit', 'InitFinished', '0', JSON.stringify(parm), 0, function (status, jsondata, targ) {

                if (status == 0) {
                    initJsondata = jsondata
                    initdata = JSON.parse(jsondata);

                    try {
                        var parm = {};
                        window.lxpc.exebusinessaction('Transmit', 'QueryAllDialog', '0', JSON.stringify(parm), 0, function (status, jsondata, targ) {
                            if (status == 0) {

                                datalist = JSON.parse(jsondata);
                                var str = '';
                                var ocon_l = document.getElementById('con_l');
                                ocon_l.innerHTML = ''

                                for (var i = 0; i < datalist.length; i++) {

                                    var curdata = datalist[i];

                                    var defalut = 'images/persion.png'
                                    if (curdata.dialogType == 3) {
                                        datalist.splice(i, 1)
                                        i--;
                                        continue;
                                    } else if (curdata.dialogType == 0) {
                                        if (curdata.photoResId == '') {
                                            defalut = 'images/ml_qunIcon.jpg'
                                        }
                                    }
                                    var branch = curdata.branchPath;
                                    if (branch == '' || branch == null || typeof(branch) == 'undefined') {
                                        branch = ''
                                    }
var strclass=''
                                    if(i==0){
                                        strclass='ml_bg'
                                    }else{
                                        strclass=''
                                    }
                                    str += `<li onclick="changeChecked(this,${i})" class="${strclass}" title="${XssToString(curdata.name)}"><em class=" aV_check "  ></em><img  src="${defalut}" alt=""><span class="name">${XssToString(curdata.name)}</span><span>${XssToString(branch)}</span></li>`

                                }
                                var ocon_l = document.getElementById('con_l');
                                ocon_l.innerHTML = str;

                                $('#con_l li').showTitle();

                                $('#con_l li').each(function(){
                                    var $ele=$(this);

                                   $ele.attr('title',$ele.find('.name').text())

                                })


                                leftScroll.refresh();
                                QueryDetailInfo(datalist)
//                                keyDown($('#con_l'),'ml_bg',leftScroll)
//                                keyDown('ml_bg',leftScroll)
                            } else {
                                console.log(status)
                            }

                        })
                    } catch (e) {
                        console.log(e.message)
                    }

                    bindsearch();

                } else {
                    my_layer({message: '调用接口出错，错误码' + status}, 'error')
                }

            })
        } catch (e) {
            my_layer({message: '调用接口出错，错误码' + e.message}, 'error')
        }


    }

    //check
    function changeChecked(ele, index) {

        var ocheck = ele.getElementsByTagName('em')[0];
        if (ocheck.classList.contains('aV_checkEd')) {

            ocheck.classList.remove('aV_checkEd')
//            ocheck.classList.add('unchecked')
            var ocon_r = document.getElementById('con_r');
            var oSeled = ocon_r.querySelector('li[userId="' + datalist[index].dialogId + '"]')

            $(oSeled).remove();
            var oSeled = ocon_r.querySelector('li[userId="' + datalist[index].dialogId + '"]')
            $(oSeled).remove();

            var ocount = document.getElementById('sel_count');
            ocount.innerHTML = parseFloat(ocount.innerHTML) - 1

            var id = memberlist.indexOf(datalist[index].dialogId)
            memberlist.splice(id, 1);
            rightScroll.refresh();

        } else{


            if (memberlist&&memberlist.length >= 50) {//超过50不能再选
                my_layer({message: '超过50人，不能添加'}, 'warn');
            } else {
//                ocheck.classList.remove('unchecked')
                ocheck.classList.add('aV_checkEd');
                var contact = datalist[index]
                addContact(contact, index);
            }
        }

        var $ele=$(ele);

        $ele.addClass('ml_bg');
        $ele.siblings().removeClass('ml_bg')

    }
    ;

    var imgId = 0,
            senderId = 0;
    //获取头像
    function getImages(parm, imgId, parent) {
        try {
            window.lxpc.exebusinessaction('DownloadResource', 'HeaderImage', '0', JSON.stringify(parm), imgId, function (status, result, targ) {

                if (status == 0) {
                    if (result == '' || result == null || typeof(result) == 'undefined') {
                        return;
                    }
                    if (parent) {
                        ;
                        var oimg = parent.querySelector('img[imgId="' + targ + '"]')
                        oimg.src = result;
                    } else {
                        var ocon_l = document.getElementById('con_l');
                        var oimg = ocon_l.querySelector('img[imgId="' + targ + '"]')
                        oimg.src = result;
                    }


                } else {
                    my_layer({message: '调用接口出错，错误码' + e.message}, 'error')
                }


            })
        } catch (e) {
            my_layer({message: '调用接口出错，错误码' + e.message}, 'error')
        }
    }
    //获取会话的详情
    function QueryDetailInfo(datalist, type) {//type 0||undefined 正常的，1搜索界面的头像

        for (var i = 0, ln = datalist.length; i < ln; i++) {
            var curdata = datalist[i],
                    ResID = curdata.photoResId;

            if (ResID == '' || typeof(ResID) == 'undefined' || ResID == null) {

                if (curdata.Extend) {
                    ResID = JSON.parse(curdata.Extend).photoResID;
                }

            }


            if (ResID != '' && typeof(ResID) != 'undefined' && ResID != null) {
                var parm = {resourceList: [{photoResId: ResID}], size: 96};

                imgId += 1;

                if (type) {
                    var ocon_l = document.getElementById('con_l_search');
                    var oimg = ocon_l.getElementsByTagName('img')[i];
                    oimg.setAttribute('imgId', imgId)
                    getImages(parm, imgId, ocon_l)
                } else {
                    var ocon_l = document.getElementById('con_l');
                    var oimg = ocon_l.getElementsByTagName('img')[i];
                    oimg.setAttribute('imgId', imgId)
                    getImages(parm, imgId)
                }
            }

        }
    }
    ;

    //往右边添加联系人
    function addContact(contact, index) {

        if (memberlist.indexOf(datalist[index].dialogId) > -1) {
            return;
        } else {

            memberlist.push(datalist[index].dialogId);

        }

        var ocount = document.getElementById('sel_count');
        ocount.innerHTML = parseFloat(ocount.innerHTML) + 1


        var str = '';
        var ocon_r = document.getElementById('con_r')
        var imgpath = document.getElementById('con_l').getElementsByTagName('img')[index].getAttribute('src')

        str = `<li ><img src="${imgpath}" alt=""><span>${XssToString(contact.name)}</span><em onclick="delContact(this,${index})"></em ></li>`

        var oli = document.createElement('li');
        oli.setAttribute('userId', contact.dialogId)
        oli.innerHTML = str;
        ocon_r.appendChild(oli);
        rightScroll.refresh();

    }

    //从左边删除选中的联系人
    function delContact(ele, index) {

        var oparent = ele.parentNode
        $(oparent).remove();
        rightScroll.refresh();
        var ocount = document.getElementById('sel_count');
        ocount.innerHTML = parseFloat(ocount.innerHTML) - 1

        var oem = document.getElementById('con_l').getElementsByTagName('em')[index]

        oem.classList.remove('aV_checkEd')
//        oem.classList.add('unchecked')

        var id = memberlist.indexOf(datalist[index].dialogId)
        memberlist.splice(id, 1);

    }


    //实现搜索联系人
    var timer = null;
    var init_search = '搜索';
    var str_search = ''
    var searchId = 0;

    function bindsearch() {

        var osearch = document.getElementById('search');
        var odel = document.getElementById('search_del');


        $('#search').focusin(function (e) {

            if ($(this).val() == init_search) {
                $(this).val('');
            }

            if ($(this).val().trim() == '') {
                odel.style.display = 'none'
                $('#con_l').show()
                $('#con_l_search').hide();
                $('.Contact_load').hide()
                $('#con_l_search').empty();
                ;

            } else {
                odel.style.display = 'block'
                $('#con_l').hide()
                $('#con_l_search').show();

            }

            timer = setInterval(search, 500);
            leftScroll.refresh();


        }).focusout(function () {
            clearInterval(timer)

            if ($(this).val().trim() == '' || $(this).val().trim() == init_search) {
                odel.style.display = 'none'
                $(this).val(init_search);
                str_search = ''
            } else {
                odel.style.display = 'block'

            }
            ;
        });

        odel.onclick = function () {
            odel.style.display = 'none'
            osearch.value = '';

            $('#con_l_search').hide();
            $('.Contact_load').hide()
            $('#con_l').show()
            $('#con_l_search').empty();

            leftScroll.refresh();
            $(osearch).trigger("focus");

        }


        function search(ev) {
            var txt = '';
            txt = $('#search').val().trim()

            if (txt == '' || txt == init_search) {
                odel.style.display = 'none'

                $('#con_l').show()
                leftScroll.refresh();
                $('#con_l_search').hide();
                $('#con_l_search').empty();

            } else {

                odel.style.display = 'block'
                $('#con_l').hide()
                $('#con_l_search').show();


            }
            if (str_search == txt) {
                $('.Contact_load').hide()

                return;
            } else {
                str_search = txt;
                $('#con_l_search').empty();

                getSearch()
            }
        }

        //绑定搜索结果
        function getSearch() {
            var txt = '';
            txt = $('#search').val().trim()

            var str = txt.trim();
            if (str == '' || str == null) {
                return;
            }
            $('.Contact_load').show()
            try {

                var parm = {searchKeyWord: str};

                searchId = searchId + 1;

                window.lxpc.exebusinessaction('Transmit', 'SearchUserDialogAndMember', '0', JSON.stringify(parm), searchId, function (status, jsondata, targ) {

                    if (status == 0) {

                        if (targ != searchId) {
                            $('.Contact_load').hide()
                            return;
                        }

                        var data = JSON.parse(jsondata);

                        if (data == null) {
                            $('#con_l_search').append(`<div class="noSearch" style="position: absolute;top: 150px;text-align: center;width: 100%;display: block">
                                    <span>没有搜索结果</span>
                                    </div>`)
                            leftScroll.refresh();
                            $('.Contact_load').hide()

                            return;
                        }
                        var PersonContacts = data.userDialog;
                        var StructContacts = data.member;


                       if( (!PersonContacts || (PersonContacts && PersonContacts.length == 0)) && (!StructContacts || (StructContacts&&StructContacts.length == 0)))  {

                            $('#con_l_search').append(`<div class="noSearch" style="position: absolute;top: 150px;text-align: center;width: 100%;display: block">
                                    <span>没有搜索结果</span>
                                    </div>`)
                            $('.Contact_load').hide()
                            leftScroll.refresh();

                            return;
                        }
                        var str = ''

                        if (PersonContacts && PersonContacts.length > 0) {

                            str += '<h6 class="contactType">最近会话</h6><ul>';
                            for (var m = 0; m < PersonContacts.length; m++) {
                                var aperson = PersonContacts[m];

                                var sName = '',
                                        branch = aperson.branchPath,
                                        resId = JSON.parse(aperson.Extend).photoResID


                                if (branch == '' || branch == null || typeof(branch) == 'undefined') {
                                    branch = ''
                                }


                                sName = aperson.Name

                                var checkstatus = ''


                                if (memberlist.indexOf(aperson['DialogID']) > -1) {

                                    checkstatus = 'aV_checkEd'

                                } else {
                                    checkstatus = ''
                                }

                                var strPath = ''
                                if (aperson.DialogType == 0) {
                                    strPath = './images/head_group.png'
                                } else if (aperson.DialogType = 2) {
                                    strPath = "./images/persion.png"
                                }


                                str += '<li userUniId="' + aperson['DialogID'] + '"><em class=" aV_check ' + checkstatus + '" ></em><img photoResId="' + resId + '" src="' + strPath + '" alt=""><span >' + XssToString(sName) + '</span><span >' + XssToString(branch) + '</span></li>'

                            }
                            str += '</ul>'

                        }
                        if (StructContacts && StructContacts.length > 0) {
                            str += '<h6 class="contactType">组织联系人</h6><ul>';
                            for (var m = 0; m < StructContacts.length; m++) {
                                var astruct = StructContacts[m];

                                var checkstatus = ''
                                if (memberlist.indexOf(astruct['userUniId']) > -1) {

                                    checkstatus = 'aV_checkEd'

                                } else {
                                    checkstatus = ''
                                }


                                str += '<li userUniId="' + astruct['userUniId'] + '"><em class="aV_check ' + checkstatus + '" ></em><img photoResId="' + astruct.photoResId + '" src="./images/persion.png" alt=""><span >' + XssToString(astruct.name) + '</span><span>' + XssToString(astruct.path) + '</span></li>'

                            }
                            str += '</ul>'
                        }
                        //str+='</ul>'

                        //str += '';

                        $('#con_l_search').append(str);
                        $('.Contact_load').hide()

                        leftScroll.refresh();

                        //获取头像

                        if (PersonContacts && StructContacts) {
                            QueryDetailInfo(PersonContacts.concat(StructContacts), 1)
                        } else if (!PersonContacts && StructContacts) {
                            QueryDetailInfo(StructContacts, 1)
                        } else if (PersonContacts && !StructContacts) {
                            QueryDetailInfo(PersonContacts, 1)
                        }

                        $('.contacts_search_con li').on('click', function () {

                            var $li = $(this);
                            var $em = $li.children('em');
                            var userId = $li.attr('userUniId');
                            var imgpath = $li.children('img').attr('src');
                            var name = $li[0].getElementsByTagName('span')[0].innerHTML;

                            $('.contacts_search_con li').removeClass('ml_bg');
                            $li.addClass('ml_bg');

                            if ($em.hasClass('aV_checkEd')) {
                                $em.removeClass('aV_checkEd');
                                $('.contacts_right_scroll .SelecedContact li[userUniId="' + userId + '"]').remove()

                                updataCount()
                                leftScroll.refresh();
                                var index = memberlist.indexOf(userId);
                                memberlist.splice(index, 1);

                            } else {

                                $em.addClass('aV_checkEd');
                                var str = '';

                                if (memberlist.indexOf(userId) > -1) {
                                    return;//有相同userUniID的不再加进去
                                } else {
                                    memberlist.push(userId);
                                }

                                str += '<li  userUniId="' + userId + '" ><img src="' + imgpath + '" alt="" ><span>' + name + '</span><em></em></li>';
                                $('.contacts_right_scroll .SelecedContact').append(str);
                                //$('.contacts_right h5').html('已选取' + $('.SelecedContact li').length + '人');

                                leftScroll.refresh();
                                updataCount();
                                $('.SelecedContact li:last em').click(function () {

                                    var $ele = $(this),
                                            index = $('.SelecedContact li em').index($ele);

                                    $('.contacts_search_con li[userUniId="' + memberlist[index] + '"] em ').removeClass('aV_checkEd');

                                    $(this).parent().remove();
                                    memberlist.splice(index, 1);

                                    updataCount()

                                })


                            }


                        });


                    }
                })


            }
            catch (e) {
                console.log(e.message)
            }

        }

//更新选中个数
        function updataCount() {

            $('#sel_count').html($('.SelecedContact li').length)
        }


    }


    //确认通知
    function confirmSelectPeople(parm) {
        try {
            window.lxpc.exebusinessaction('Transmit', 'ConfirmSelectPeople', '0', JSON.stringify(parm), 0, function (status, jsondata, targ) {
                if (status == 0) {

                    try {
                        window.lxpc.closewnd();
                    }
                    catch (e) {
                        console.log(e.message)
                    }

                } else {
                    my_layer({message: '调用接口出错，错误码' + status}, 'error')
                }


            })
        } catch (e) {
            my_layer({message: '调用接口出错，错误码' + e.message}, 'error')
        }

    }

    function bindEvent() {
        var ocloas = document.getElementsByClassName('Winclose')[0];
        ocloas.onclick = function (ev) {
            try {
                window.lxpc.closewnd();
            }
            catch (e) {
                console.log(e.message)
            }
        }
        //取消
        var btnCancel = document.getElementById('btnCancel');
        btnCancel.onclick = function () {
            try {
                window.lxpc.closewnd();

            } catch (e) {
                my_layer({message: '调用接口出错，错误码' + e.message}, 'error')
            }

        }


        //确认联系人

        var obtnOk = document.getElementById('btnOk');
        obtnOk.onclick = function () {

            var parm = {
                fromCode: initdata.fromCode, userlist: memberlist, initData: initJsondata
            }

            confirmSelectPeople(parm)


        }
//监听键盘事件
        document.onkeydown = function (event) {


//            keyDown($('#con_l'),'ml_bg',leftScroll)
//            keyDown($('#con_l_search'),'ml_bg',leftScroll)
            var sSearch=$('#search').val()

            if(sSearch==''||sSearch=='搜索'){
                keyDown($('#con_l'),'ml_bg',leftScroll)
            }else{
                keyDown($('#con_l_search'),'ml_bg',leftScroll)
            }


        }


    }

    //支持上下键
    function keyDown($box, hightclass,mainScroll) {




        var  children=$box.find('li'),
                total=children.length;
        var olist= Array.from(children);

        var seledli=$box.find('.'+hightclass)
        var check=seledli.find('.aV_check')
        var keyIndex =olist.findIndex(function(item, index, arr){
            return item.classList.contains(hightclass)
        });

        var  curIndex=keyIndex;


        if (total == 0 || total == 1) {
            return;
        }
        if (event.keyCode == 38)//上
        {

            if (keyIndex == 0) {
                curIndex = total - 1;
            } else {
                curIndex = keyIndex - 1;
            }
            clickTr(curIndex)
        }
        if (event.keyCode == 40)//下
        {

            if (keyIndex == total - 1) {
                curIndex = 0;
            } else {
                curIndex = keyIndex + 1;
            }
            clickTr(curIndex)
        }
        if (event.keyCode==13){//确认键

            if(check.length>0){

                changeChecked(seledli[0],curIndex)
            }
        }

        function clickTr(currTrIndex) {
            var step=parseFloat(seledli[0].offsetHeight);

            if (currTrIndex > -1) {

                var oitem= olist[currTrIndex];
                oitem.classList.add(hightclass)

                if(event.keyCode == 38) {//向上
                    if(currTrIndex==total-1){
                        mainScroll.scrollTo(0,mainScroll.maxScrollY)
                    }else{

                        if((oitem.offsetTop) < Math.abs(mainScroll.y)){
                            mainScroll.scrollBy(0,step)

                        }else if((oitem.offsetTop) == Math.abs(mainScroll.y)){
                            mainScroll.scrollBy(0,0)
                        }
                    }
                }else if(event.keyCode == 40){//向下
                    if(currTrIndex==0){
                        mainScroll.scrollTo(0,0)
                    }else{
                        if((oitem.offsetTop+40) >= mainScroll.wrapperHeight){
//
                            if(Math.abs(mainScroll.maxScrollY-mainScroll.y)>10){
                                mainScroll.scrollBy(0,-step)
                            }else{
                                mainScroll.scrollTo(0,mainScroll.maxScrollY)
                            }

                        }
                    }
                }




            }

            olist[keyIndex].classList.remove(hightclass);

            keyIndex = currTrIndex;
        }

    }

</script>
