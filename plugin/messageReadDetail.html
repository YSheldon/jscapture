<!DOCTYPE html>
<html lang="en">
<head width="372" height="542">
    <meta charset="UTF-8">
    <title>消息接收人列表</title>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/layer.css">
    <script type="application/javascript" src="js/jQuery-2.1.4.min.js"></script>
    <script type="application/javascript" src="js/my_layer.js"></script>
    <script type="text/javascript" src="js/iscroll-5.1.3.min.js"></script>
    <script type="text/javascript" src="js/application.js"></script>
    <script type="text/javascript" src="./js/xss.min.js"></script>

    <style>

        .tab {
            float: left;
            width: 50%;
            height: 40px;
            text-align: center;
            font-size: 14px;
            line-height: 45px;
            color: #666;
            background: #E7E8EC;
            cursor: pointer;

        }

        .fouce {
            color: #007AE0;
            background: #fff;
        }
        /*.wrapper{*/
        /*background: #E7E8EC;*/
        /*}*/
        .wrapper, .load {
            position: absolute;
            left: 0;
            top: 72px;
            /*bottom: 42px;*/
            bottom: 0px;
            right: 0px;
            overflow: hidden;
        }

        .load {
            background: #000;
            opacity: 0.3;

        }

        .load img {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            margin: auto;
            /*background: red;*/
        }

        .scroll {
            /*padding-top: 5px;*/
            /*padding: 5px 22px;*/
        }

        .scroll h4 {
            font-weight: normal;
            margin-top: 14px;
            margin-bottom: 8px;
            color: #7c7c7c;

        }

        .listfter {
            position: absolute;
            height: 42px;
            bottom: 0px;
            left: 0;
            background: #e2e2e2;
            border-top: 1px solid #ccc;
            width: 100%;
            line-height: 42px;
            display: none;
        }

        .btn {
            height: 26px;
            width: 80px;
            background: #60ACEF;
            border: none;
            font-size: 13px;
            color: #FFFFFF;
            letter-spacing: 0px;
            float: right;
            margin-right: 32px;
            margin-top: 8px;
            border-radius: 2px;
        }

        .con {
            background: #fff;
            /*padding: 0 11px;*/
            /*min-height: 100%;*/
        }

        .con_time {
            float: right;
        }

        .con li img {
            width: 32px;
            height: 32px;
            float: left;
            margin-right: 8px;

            /*margin-top: 11px;*/
            /*display: block;*/
        }

        .con li span {
            display: block;

            /*max-width: 70px;*/
            /*!*font-size: 14px;*!*/
            /*!*text-align: center;*!*/
        }

        .con li {
            padding-top: 12px;
            padding-bottom: 11px;
            padding: 12px 11px 11px 11px;
            /*height:54px;*/
            /*line-height: 54px;*/
        }

        .con_name {
            font-size: 13px;
            line-height: 16px;
            color: #222222;
            /*margin-top: 5px;*/
        }

        .con_time {
            font-size: 12px;
            line-height: 16px;
        }

        .con_branch {
            font-size: 12px;
            color: #666;
            /*margin-top: 3px;*/
            line-height: 16px;
        }

        .top_title span {
            background: none;
            padding-left: 12px;
        }

        .noReader {
            text-align: center;
            margin-top: 30%;
            display: none;
        }

        .noReader p {
            font-size: 14px;
            color: #999999;
            margin-top: 16px;

        }
        .noData{
            background: rgba(250, 241, 201, 1);
            padding:8px;
            text-align: center;
            font-size: 14px;
            color: #d5ab5c;
        }
        .exitQun{

            text-align: center;
            /*background: #E7E8EC;*/
            padding: 15px;
            font-size: 14px;
            color: #999;

        }
        .exitQun >span{
            padding:4px 15px;
            background: #e9e9e9;
        }
        .layer_box{
            width:300px;
            height:168px;
        }

    </style>
</head>
<body>
<div class="out_box" id="G_box">
    <nav class="top_title">
        <span class="">消息接收人列表</span>
        <ul class="tool">
            <!--<li class="Winmin"></li>-->
            <!--<li class="Winmax"></li>-->
            <li class="Winclose"></li>
        </ul>
    </nav>
    <section>
        <ul class="top">
            <li class="tab fouce">未读成员<span class="unReadCount"></span></li>
            <li class="tab">已读成员<span class="ReadCount"></span></li>
            <div class="clear"></div>
        </ul>
        <div class="wrapper" id="wrapper">
            <div class="scroll">
                <ul class="con unReadcon">

                    <!--<div class="noReader" style="display: none;">-->
                        <!--<div>-->
                            <!--<img src="images/no_Reader.png" alt="">-->
                            <!--<p>无未读成员 </p>-->
                        <!--</div>-->
                    <!--</div>-->
                    <!--<li>-->
                    <!--<img src="images/persion.png" alt="">-->
                    <!--<span class="con_name">赵鹏</span>-->
                    <!--<span class="con_branch">蓝信工厂科技有限公司-蓝信-产品部</span>-->

                    <!--</li>-->


                </ul>
                <ul class="con Readcon" style="display: none;">
                    <!--<div class="noReader" style="display: none;">-->
                        <!--<div>-->
                            <!--<img src="images/no_Reader.png" alt="">-->
                            <!--<p>无已读成员</p>-->
                        <!--</div>-->
                    <!--</div>-->
                    <!--&lt;!&ndash;<li>&ndash;&gt;-->
                    <!--&lt;!&ndash;<img src="images/persion.png" alt="">&ndash;&gt;-->
                    <!--&lt;!&ndash;<span class="con_time">11-28 19:30</span>&ndash;&gt;-->
                    <!--&lt;!&ndash;<span class="con_name">赵鹏</span>&ndash;&gt;-->
                    <!--&lt;!&ndash;<span class="con_branch">蓝信工厂科技有限公司-蓝信-产品部</span>&ndash;&gt;-->
                    <!--&lt;!&ndash;</li>&ndash;&gt;-->
                    <!--&lt;!&ndash;<div class="noReader" style="display: block;">&ndash;&gt;-->
                        <!--&lt;!&ndash;<div>&ndash;&gt;-->
                            <!--&lt;!&ndash;<img src="images/no_Reader.png" alt="">&ndash;&gt;-->
                            <!--&lt;!&ndash;<p>无未读成员 </p>&ndash;&gt;-->
                        <!--&lt;!&ndash;</div>&ndash;&gt;-->
                    <!--&lt;!&ndash;</div>&ndash;&gt;-->
                </ul>

            </div>
        </div>
        <div class="load " style="display:none">
            <img src="images/ajax-loader_smail.gif" alt="">
        </div>
        <!--<div class="noReader" style="display:none">-->
            <!--<div>-->
                <!--<img src="../../images/no_Reader.png" alt="">-->
                <!--<p>无未读成员 </p>-->
            <!--</div>-->
        <!--</div>-->
        <div class="noData" style="display: none;">由于该消息已发出较长时间，不再更新已读状态</div>
    </section>
    <footer class="listfter" style="display: none;">

        <button class="btn">追一下</button>
    </footer>
</div>
</body>
</html>
<script>

    //    window.onload = function () {
    //添加滚动条
    var settings = scrollSetings();
    var scroll = new IScroll("#wrapper", settings);

    TitleTools();
    bindEvent();
    //初始化数据

    var Initdata,
            selfuserUniId;


    function setNoReader(parent,tip){
            var str=`<div class="noReader" style="display: block;">
                <div>
                    <img src="images/no_Reader.png" alt="">
                        <p>${tip} </p>
                </div>
            </div>`

        parent.append(str)
    }


    try {
        var parm = {};
        window.lxpc.exebusinessaction('ReadDetail', 'InitFinished', '0', JSON.stringify(parm), 0, function (status, jsondata, targ) {
            if (status == 0) {
                var data = JSON.parse(jsondata);
                Initdata = jsondata;
                selfuserUniId=data.selfUserUniId;
                document.getElementsByClassName('noData')[0].style.display='none';

                try {

                    window.lxpc.exebusinessaction('MsgDetail', 'GetMessageReadDetail', '0', jsondata, 0, function (status, jsondata1, targ) {
                        if (status == 0) {


                            //绑定数据

                           var data=JSON.parse(jsondata1)
                            var datalist=data.readDetail


                            imgId = 0

                            var oload = document.getElementsByClassName('load')[0];
                            oload.style.display = 'none';

                            document.getElementsByClassName('unReadcon')[0].innerHTML = '';
                            document.getElementsByClassName('Readcon')[0].innerHTML = '';

                            if(datalist==null||datalist==''||typeof(datalist)=='undefined'){

                                document.getElementsByClassName('noData')[0].style.display='block';

//                                $('.unReadcon').append(str);
//                                $('.Readcon').append(str);


                                return;

                            }else if(datalist.length==0){

                                setNoReader($('.unReadcon'),'无未读成员')
                                setNoReader($('.Readcon'),'无已读成员')
                                return;
                            }

                            binddata(data);
                            //获取头像
                            getimages(datalist);


                        } else {

                            if(status==2069||status==11){

                                if(status==2069){
                                    var strtitle='服务异常，错误:'+status
                                }else{
                                    var strtitle='您所在的平台暂不支持查看消息接收人列表'
                                }


                               var str=`<div class="noReader" style="display: block;">
                                    <div>
                                        <img src="images/allNoConfirm.png" alt="">
                                            <p>${strtitle}</p>
                                    </div>
                                </div>`

                            $('.unReadcon').append(str);
                            $('.Readcon').append(str);
                            }else{
                                my_layer({message: '请求数据出错错误码' + status}, 'error')
                            }


                        }
//
                    })
                } catch (e) {

                    my_layer({message: '请求数据出错错误码' + e.message}, 'error')
                }
            } else {
                my_layer({message: '请求数据出错错误码' + status}, 'error')
            }
        })


    } catch (e) {
        my_layer({message: '请求数据出错错误码' + e.message}, 'error')
    }

    //    }
    //获取数据
    function binddata(data) {

        var strNo = '';
        var str = '';
        var unRcount=0,
            Rcount=0;
        var  datalist=data.readDetail

        datalist=datalist.sort(function(a,b){
            return b.readTime- a.readTime

        })

        for (var i = 0, ln = datalist.length; i < ln; i++) {
            var curdata = datalist[i],
                    time = curdata.readTime,
                    branch = XssToString(curdata.branchPath);
            

            if (branch == '' || branch == null || typeof(branch) == 'undefined') {
                branch = ''
            }


            if (time == 0) {//未读

                strNo += ` <li><img src="images/persion.png" alt="">
                          <span class="con_name">${XssToString(curdata.name)}</span>
                        <span class="con_branch">${branch}</span></li>`;

                unRcount++;

            } else {

                if(selfuserUniId==curdata.userUniId){//不显示自己
                    continue;
                }


                var newtime = FormatTime(curdata.readTime, 'mm-dd hh:mm','yyyy')
//                var newtime = FormatTime(curdata.readTime, 'yyyy/mm/dd hh:mm')

                str += `<li>
                                         <img src="images/persion.png" alt="">
                        <span class="con_time">${newtime}</span>
                        <span class="con_name">${XssToString(curdata.name)}</span>
                        <span class="con_branch">${branch}</span></li>`
                Rcount++;
            }
        }

        var readQuitCount=data.readQuitCount;
        var unReadQuitCount=data.unReadQuitCount;

        if(data.readQuitCount>0){
            str += `<div class="exitQun"><span>有<span>${data.readQuitCount}</span>名已读成员已退群</span></div><div class="clear"></div>`;
        }else{
            str += '<div class="clear"></div>';
        }

        if(data.unReadQuitCount>0){
            strNo += `<div class="exitQun"><span>有<span>${data.unReadQuitCount}</span>名未读成员已退群</span></div><div class="clear"></div>`
        }else{
            strNo += '<div class="clear"></div>'
        }

        if(unRcount==0){

            setNoReader($('.unReadcon'),'无未读成员')
        }else{
            $('.unReadcon').append(strNo);
            var oUnR = document.getElementsByClassName('unReadCount')[0];
            oUnR.innerHTML = '('+unRcount+')';
        }
        if(Rcount==0){
            setNoReader($('.Readcon'),'无已读成员')
        }else{
            $('.Readcon').append(str);
            var oR = document.getElementsByClassName('ReadCount')[0];
            oR.innerHTML = '('+Rcount+')';
        }

        scroll.refresh();





    }

    var imgId = 0;

    function getimages(datalist) {
        for (var i = 0, ln = datalist.length; i < ln; i++) {
            var curdata = datalist[i],
                    ResID = datalist[i].resID;

            if (ResID != '' && typeof(ResID) != 'undefined' && ResID != null) {
                var parm = {resourceList: [{photoResId: ResID}],size:96};
                imgId += 1;
                downresource(parm, imgId, function (result, targ) {

                    if (result == '' || result == null || typeof(result) == 'undefined'||result.indexOf('\\')==-1) {
                        return;
                    }
                    var oimg = document.getElementsByTagName('img')[targ - 1];
                    oimg.src = result;
                    oimg.onerror=function(){
                        this.src='images/persion.png'
                    }

                })


            }


        }
        
    }

    function bindEvent() {
//        切换tab
        $('.tab').on('click', function () {
            var $ele = $(this);
            $ele.addClass('fouce')
            $ele.siblings().removeClass('fouce')

            var index = $ele.index();
            $('.con').hide();
            $('.con').eq(index).show();
            scroll.refresh();

        })

        //对未确认的成员进行追加
        var oBtn = document.getElementsByClassName('btn')[0];
        oBtn.onclick = function () {
            try {
                window.lxpc.exebusinessaction('MsgDetail', 'RemindCall', '0', Initdata, 0, function (status, result, targ) {

                    if (status == 0) {
                        my_layer({message: '追加成功'}, 'success')
                    } else {

                        my_layer({message: '暂不支持'}, 'warn')
                    }

                })

            } catch (e) {

                my_layer({message: '暂未支持'}, 'warn')
                console.log(e.message)
            }
        };
        
    };




</script>